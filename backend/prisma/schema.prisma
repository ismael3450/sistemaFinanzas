generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ENUMS
// ============================================

enum Role {
  OWNER
  ADMIN
  TREASURER
  MEMBER
  VIEWER
}

enum TransactionType {
  INCOME
  EXPENSE
  TRANSFER
}

enum TransactionStatus {
  PENDING
  COMPLETED
  CANCELLED
  VOIDED
}

enum CategoryType {
  INCOME
  EXPENSE
  BOTH
}

enum SubscriptionStatus {
  ACTIVE
  INACTIVE
  CANCELLED
  PAST_DUE
  TRIALING
}

enum PaymentStatus {
  PENDING
  APPROVED
  DECLINED
  VOIDED
  ERROR
}

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  VOID
  EXPORT
  INVITE
  REVOKE
}

// ============================================
// USER & AUTH
// ============================================

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password      String
  firstName     String    @map("first_name")
  lastName      String    @map("last_name")
  phone         String?
  avatarUrl     String?   @map("avatar_url")
  emailVerified Boolean   @default(false) @map("email_verified")
  isActive      Boolean   @default(true) @map("is_active")
  lastLoginAt   DateTime? @map("last_login_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  memberships          Membership[]
  createdOrganizations Organization[] @relation("CreatedBy")
  transactions         Transaction[]
  auditLogs            AuditLog[]
  refreshTokens        RefreshToken[]
  activeOrganization   Organization?  @relation("ActiveOrganization", fields: [activeOrgId], references: [id])
  activeOrgId          String?        @map("active_org_id")

  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String    @map("user_id")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime  @map("expires_at")
  createdAt DateTime  @default(now()) @map("created_at")
  revokedAt DateTime? @map("revoked_at")

  @@map("refresh_tokens")
}

// ============================================
// ORGANIZATION & MEMBERSHIP
// ============================================

model Organization {
  id              String   @id @default(uuid())
  name            String
  slug            String   @unique
  description     String?
  logoUrl         String?  @map("logo_url")
  currency        String   @default("USD")
  timezone        String   @default("America/El_Salvador")
  fiscalYearStart Int      @default(1) @map("fiscal_year_start")
  isActive        Boolean  @default(true) @map("is_active")
  createdById     String   @map("created_by_id")
  createdBy       User     @relation("CreatedBy", fields: [createdById], references: [id])
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relations
  memberships    Membership[]
  accounts       Account[]
  categories     Category[]
  paymentMethods PaymentMethod[]
  transactions   Transaction[]
  auditLogs      AuditLog[]
  subscription   OrganizationSubscription?
  activeUsers    User[]                    @relation("ActiveOrganization")

  @@map("organizations")
}

model Membership {
  id             String       @id @default(uuid())
  userId         String       @map("user_id")
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  role           Role         @default(MEMBER)
  isActive       Boolean      @default(true) @map("is_active")
  invitedAt      DateTime     @default(now()) @map("invited_at")
  joinedAt       DateTime?    @map("joined_at")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  @@unique([userId, organizationId])
  @@map("memberships")
}

// ============================================
// ACCOUNTS
// ============================================

model Account {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  accountType    String       @map("account_type") // cash, bank, digital, etc.
  currency       String       @default("USD")
  initialBalance BigInt       @default(0) @map("initial_balance") // in minor units (cents)
  currentBalance BigInt       @default(0) @map("current_balance") // in minor units (cents)
  isActive       Boolean      @default(true) @map("is_active")
  color          String?
  icon           String?
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  transactionsFrom Transaction[] @relation("FromAccount")
  transactionsTo   Transaction[] @relation("ToAccount")

  @@unique([organizationId, name])
  @@map("accounts")
}

// ============================================
// CATEGORIES
// ============================================

model Category {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  type           CategoryType @default(BOTH)
  parentId       String?      @map("parent_id")
  parent         Category?    @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children       Category[]   @relation("CategoryHierarchy")
  color          String?
  icon           String?
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  transactions Transaction[]

  @@unique([organizationId, name, parentId])
  @@map("categories")
}

// ============================================
// PAYMENT METHODS
// ============================================

model PaymentMethod {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  isActive       Boolean      @default(true) @map("is_active")
  createdAt      DateTime     @default(now()) @map("created_at")
  updatedAt      DateTime     @updatedAt @map("updated_at")

  // Relations
  transactions Transaction[]

  @@unique([organizationId, name])
  @@map("payment_methods")
}

// ============================================
// TRANSACTIONS
// ============================================

model Transaction {
  id             String       @id @default(uuid())
  organizationId String       @map("organization_id")
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  type   TransactionType
  status TransactionStatus @default(PENDING)

  // Money fields (stored in minor units)
  amount   BigInt
  currency String @default("USD")

  description String?
  reference   String? // external reference number

  // Relations
  categoryId String?   @map("category_id")
  category   Category? @relation(fields: [categoryId], references: [id])

  fromAccountId String?  @map("from_account_id")
  fromAccount   Account? @relation("FromAccount", fields: [fromAccountId], references: [id])

  toAccountId String?  @map("to_account_id")
  toAccount   Account? @relation("ToAccount", fields: [toAccountId], references: [id])

  paymentMethodId String?        @map("payment_method_id")
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])

  createdById String @map("created_by_id")
  createdBy   User   @relation(fields: [createdById], references: [id])

  // Dates
  transactionDate DateTime  @map("transaction_date")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  voidedAt        DateTime? @map("voided_at")
  voidReason      String?   @map("void_reason")

  // Attachments
  attachments TransactionAttachment[]

  @@index([organizationId, transactionDate])
  @@index([organizationId, type])
  @@index([organizationId, status])
  @@map("transactions")
}

model TransactionAttachment {
  id            String      @id @default(uuid())
  transactionId String      @map("transaction_id")
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  fileName      String      @map("file_name")
  fileUrl       String      @map("file_url")
  fileType      String      @map("file_type")
  fileSize      Int         @map("file_size")
  createdAt     DateTime    @default(now()) @map("created_at")

  @@map("transaction_attachments")
}

// ============================================
// SUBSCRIPTIONS & PLANS (Wompi Integration)
// ============================================

model SubscriptionPlan {
  id            String  @id @default(uuid())
  name          String  @unique
  description   String?
  price         BigInt // in minor units (cents)
  currency      String  @default("USD")
  interval      String  @default("month") // month, year
  intervalCount Int     @default(1) @map("interval_count")

  // Features
  maxUsers        Int     @default(5) @map("max_users")
  maxAccounts     Int     @default(10) @map("max_accounts")
  maxTransactions Int     @default(1000) @map("max_transactions") // per month
  hasExports      Boolean @default(true) @map("has_exports")
  hasReports      Boolean @default(true) @map("has_reports")
  hasAuditLog     Boolean @default(false) @map("has_audit_log")
  hasApiAccess    Boolean @default(false) @map("has_api_access")

  trialDays Int     @default(14) @map("trial_days")
  isActive  Boolean @default(true) @map("is_active")
  isPublic  Boolean @default(true) @map("is_public")
  sortOrder Int     @default(0) @map("sort_order")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  subscriptions OrganizationSubscription[]

  @@map("subscription_plans")
}

model OrganizationSubscription {
  id             String           @id @default(uuid())
  organizationId String           @unique @map("organization_id")
  organization   Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  planId         String           @map("plan_id")
  plan           SubscriptionPlan @relation(fields: [planId], references: [id])

  status SubscriptionStatus @default(TRIALING)

  // Wompi fields
  wompiSubscriptionId String? @unique @map("wompi_subscription_id")
  wompiCustomerId     String? @map("wompi_customer_id")

  // Billing
  currentPeriodStart DateTime  @map("current_period_start")
  currentPeriodEnd   DateTime  @map("current_period_end")
  trialEndsAt        DateTime? @map("trial_ends_at")
  cancelledAt        DateTime? @map("cancelled_at")
  cancelReason       String?   @map("cancel_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  payments SubscriptionPayment[]

  @@map("organization_subscriptions")
}

model SubscriptionPayment {
  id             String                   @id @default(uuid())
  subscriptionId String                   @map("subscription_id")
  subscription   OrganizationSubscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  amount   BigInt // in minor units
  currency String        @default("USD")
  status   PaymentStatus @default(PENDING)

  // Wompi fields
  wompiTransactionId String? @unique @map("wompi_transaction_id")
  wompiPaymentMethod String? @map("wompi_payment_method")
  wompiResponse      Json?   @map("wompi_response")

  paidAt        DateTime? @map("paid_at")
  failedAt      DateTime? @map("failed_at")
  failureReason String?   @map("failure_reason")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("subscription_payments")
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id             String        @id @default(uuid())
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  userId         String?       @map("user_id")
  user           User?         @relation(fields: [userId], references: [id], onDelete: SetNull)

  action     AuditAction
  module     String // auth, organizations, transactions, etc.
  entityType String?     @map("entity_type") // User, Transaction, Account, etc.
  entityId   String?     @map("entity_id")

  oldValues Json? @map("old_values")
  newValues Json? @map("new_values")
  metadata  Json?

  ipAddress String? @map("ip_address")
  userAgent String? @map("user_agent")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([organizationId, createdAt])
  @@index([userId, createdAt])
  @@index([module, createdAt])
  @@map("audit_logs")
}
